{% extends "TisseoBoaBundle::datatable_list_stops.html.twig" %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets 'components/jquery-ui/themes/smoothness/jquery-ui.css'
                   filter='cssrewrite' output='css/calendar_boa.css' %}
        <link rel="stylesheet" href="{{ asset_url }}?{{ assets_version }}" />
    {% endstylesheets %}
{% endblock %}


{% block main_content -%}
    <style>
        #route_table {
            display: table;
            width: 100%;
            overflow: auto;
        }
        #route_stop_table {
            display: table;
        }
        .t-row {
            display: table;
        }
        .t-header {
            display: table;
            font-weight: bold;
        }
        .t-body {
            display: table;
        }
        .t-cell {
            display: table-cell;
        }
        .rank-column {
            width: 40px;
        }
        .city-column {
            width: 200px;
        }
        .name-column {
            width: 200px;
        }
        .code-column {
            width: 100px;
        }
        .checkbox-column {
            width: 80px;
        }
    </style>

    {{ form_start(form) }}
        <div id="route-fields" class="form form-edit">
            <div class="col-md-12">
                <div class = "col-md-4">
                    {{ form_row(form.name) }}
                </div>
                <div class = "col-md-4">
                    {{ form_row(form.way) }}
                </div>
            </div>
        </div>

        <table id="route-table">
            <tr>
                <td>
                    <div style="height: 45px;" class="stop_table_header">{{ 'route.route_details' | trans }}</div>
                    <table id="route-stop-table" class="table datatable table-hover dataTable no-footer">
                        <thead>
                            <th>
                                <div style="min-height: 20px">
                                    {{ 'route.route_stops.labels.rank' | trans }}
                                </div>
                            </th>
                            <th>{{ 'route.route_stops.labels.city' | trans }}</th>
                            <th>{{ 'route.route_stops.labels.name' | trans }}</th>
                            <th>{{ 'route.route_stops.labels.code' | trans }}</th>
                            <th>{{ 'route.route_stops.labels.no_drop_off' | trans }}</th>
                            <th>{{ 'route.route_stops.labels.no_pick_up' | trans }}</th>
                            {% if route.way == 'Zonal' %}
                                <th>{{ 'route.route_stops.labels.internal_service' | trans }}</th>
                            {% endif %}
                        </thead>
                        <tbody>
                            {% for rs in routeStops %}
                                <tr class="sortable">
                                    <td>
                                        {{ rs.rank }}
                                    </td>
    {#                                <td>{{ rs.id }}</td>  #}
                                    <td>{{ rs.waypoint.stop.stopArea.city.name }}</td>
                                    <td>{{ rs.waypoint.stop.stopArea.shortName }}</td>
                                    <td>{{ rs.waypoint.stop.stopDatasources[0].code }}</td>
                                    <td>{{ rs.dropOff ? 'NON': 'OUI' }}</td>
                                    <td>
                                        <div style="min-height: 35px; vertical-align: middle">{{ rs.pickup ? 'NON': 'OUI' }}</div>
                                    </td>
                                    {% if route.way == 'Zonal' %}
                                        <td>{{ rs.internalService ? 'OUI': 'NON' }}</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
                <td>###</td>
                <td>
                    <div style="height: 45px;" class="stop_table_header">
                        {{ 'route.templates_services' | trans }}
                        <a style="float:right" class="btn btn-default" id="add-trip">
                            <span class="glyphicon glyphicon-plus"></span>
                        </a>
                    </div>
                    <table id="trip-table"  class="table datatable table-hover dataTable no-footer">
                        <thead>
                            <th>
                                <div style="min-height: 20px"></div>
                            </th>
                        </thead>
                        <tbody>
                            {% for rs in routeStops %}
                                <tr id="{{ rs.id }}">
                                    <td>
                                        <div style="min-height: 35px">
                                            <a style="color: red; float:right" class="btn btn-default" id="remove-route_stop">
                                                <span class="glyphicon glyphicon-remove"></span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            <tr>
                <td colspan=3>
                    <div style="min-height: 35px">
                        <a style="float:right" class="btn btn-default" id="add-route-stop">
                            <span class="glyphicon glyphicon-plus"></span>
                        </a>
                    </div>
                </td>
            </tr>         
        </table>
    {{ form_end(form) }}
}
{% endblock %}

{% block javascripts %}
    <script>
        require(['jquery', 'jquery_ui_sortable'], function ($) {
            var $stopTimes = JSON.parse("{{ serviceTemplates | json_encode | e('js') }}");

            function FormatDate(d) {
                var h = d.getHours();
                if( h < 10 ) h = "0" + h;
                var m = d.getMinutes();
                if( m < 10 ) m = "0" + m;
                return h + ":" + m;
            }

            function loadStoptimes() {
                $.each($stopTimes, function( $trip_id, $datas ) {
                    var $index = 0;
                    $.each($datas, function( $key, $value ) {
                        var $FormattedDate = FormatDate(new Date($value['arrivalTime']*1000));
                        if( $index == 0 ) {
                            $("#trip-table thead th:last").before("<th>" + $value['name'] + "</th>")
                        }
                        $("#trip-table tbody tr#" + $value['route_stop_id'] + " td:last").before("<td>" + $FormattedDate + "</td>");
                        $index += 1;
                    });
                });
            };

            function addRouteStop() {
                $("#route-stop-table tbody").append("<tr><td>COUCOU</td></tr>");
                $('#trip-table tbody').append("<tr><td>COUCOU</td></tr>");
            };

            $(document).ready(function () {
                var $current_rank = 0;
                $( "#route-stop-table tbody" ).sortable(
                    {
                        items: '.sortable',
                        stop: function(event, ui) {
                            $(this).find('tr').each(function(i){
                                $(this).find('td:first').text( i+1 );
                            });
                        }
                    }
                );

                loadStoptimes();

                $( "#add-route-stop" ).click(function() {
                    addRouteStop();
                });                
            });
        });
    </script>
{% endblock %}