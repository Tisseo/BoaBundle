{% extends "TisseoBoaBundle::container2.html.twig" %}

{% macro getStopName(stopHistories) %}
	{% for sh in stopHistories if ( sh.startDate.date|date('Ymd') <= 'now'|date('Ymd') and ( sh.endDate is empty or sh.endDate.date|date('Ymd') <= 'now'|date('Ymd') ) ) %}
		{{ sh.shortName }}
	{% endfor %}
{% endmacro %}


{% block stylesheets %}
    {{ parent() }}
    {% stylesheets 'components/jquery-ui/themes/smoothness/jquery-ui.css'
                   filter='cssrewrite' output='css/stop_boa.css' %}
        <link rel="stylesheet" href="{{ asset_url }}?{{ assets_version }}" />
    {% endstylesheets %}
    {% stylesheets 'bundles/tisseoboa/css/jquery.dataTables.min.css'
                   filter='cssrewrite' output='css/datatables_boa.css' %}
        <link rel="stylesheet" href="{{ asset_url }}?{{ assets_version }}" />
    {% endstylesheets %}	
{% endblock %}

{% block main_content %}
    <h1>{{ title|trans({}, 'default') }}</h1>
    <hr/>
	
	{{ form_start(form) }}
		{{ form_errors(form) }}
		{{ form_widget(form._token) }}
		
		<div class="row">
			<div class = "col-md-2"> {{ form_label(form.shortName) }} </div>
			<div class = "col-md-4"> {{ form_widget(form.shortName) }} </div> 
		</div>
		<div class="row">
			<div class = "col-md-2"> {{ form_label(form.longName) }} </div>
			<div class = "col-md-4"> {{ form_widget(form.longName) }} </div>
		</div>

		{# city #}
		<div class="row">
			<div class = "col-md-2"> {{ form_label(form.city) }} </div>
			<div class = "col-md-4">
				{{ form_widget(form.city, { 'attr': {'class': 'hide'}}) }}
				
				{% set readonly = "" %}
				{% if cityMain is not empty %}
					{% set readonly = "readonly='readonly'" %}
				{% endif %}
				<input type="text" id="city"  class="form-control" data-url="{{ path('tisseo_boa_json_city') }}" value='{{ cityLabel }}' {{readonly}}>
			</div>
		</div>
		
		{# datasource #}
		<div class="row">
			{% if stopArea.id is not null %}
				{% set datasource_list = form_widget(form.stopAreaDatasources[0].datasource) %}
				{% set datasource_code = form_widget(form.stopAreaDatasources[0].code) %}
			{% else %}
				{#new record#}
				{% set datasource_list = form_widget(form.stopAreaDatasources.vars.prototype.datasource) %}
				{% set datasource_list = datasource_list | replace( {'__name__': 0} ) %}
				{% set datasource_code = form_widget(form.stopAreaDatasources.vars.prototype.code) %}
				{% set datasource_code = datasource_code | replace( {'__name__': 0} ) %}
			{% endif %}
			<div class = "col-md-2"> {{ form_label(form.stopAreaDatasources) }} </div>			
			<div class = "col-md-3">
				{{ datasource_list | raw }} 
			</div>
			
			<div class = "col-md-3">
				{{ datasource_code | raw }} 
			</div>
		</div>
		
		{% if cityMain is not empty %}
			<b>{{ 'stop_area.labels.main_city' | trans({ '%s%': cityMain }) }}<b>
		{% endif %}

		{# form button #}
		<div class="row" style="padding: 10px 0 0">
			<div class = "col-md-2 col-md-offset-3">
				<button type="submit" id="save-form" class="btn btn-success">
					<span class="glyphicon glyphicon-pencil"></span>
					 {{'global.save'|trans}}
				</button>			
			</div>
		</div>

		{{ form_end(form, { 'render_rest': false} ) }}
		
		{# stops #}
		<div>
			<div class="stop_table_header">{{ 'stop_area.stop.header' | trans }}</div>
			<table id="datatable" class="table table-hover dataTable no-footer" role="grid" aria-describedby="datatable_info">
			<thead>			
				<th>{{ 'stop_area.stop.columns.agency' | trans }}</th>
				<th>{{ 'stop_area.stop.columns.code' | trans }}</th>
				<th>{{ 'stop_area.stop.columns.name' | trans }}</th>
				<th>{{ 'stop_area.stop.columns.x' | trans }}</th>
				<th>{{ 'stop_area.stop.columns.y' | trans }}</th>
				<th>{{ 'stop_area.stop.columns.lines' | trans }}</th>
				<th>Action</th>
			</thead>
			<tbody>
			{% for stop in stops %}
				<tr>
					<td> {{ stop.stopDatasources[0].datasource.agency.name }} </td>
					<td>{{ stop.stopDatasources[0].code }}</td>
					<td>
						<a href="{{ path('tisseo_boa_stop_edit', {'StopId': stop.id }) }}">
						{{ stop.getShortLabel }}
					</td>
					{% if stop.masterStop is not empty %}
						<td colspan="3"><b>{{ 'Fant√¥me de ' ~ stop.getMasterStopLabel }}</b></td>
						<td class="hide"></td>
						<td class="hide"></td>
					{% else %}
						<td>{{ stop.stopHistories[0].theGeom.x }}</td>
						<td>{{ stop.stopHistories[0].theGeom.y }}</td>
						<td>Lignes</td>
					{% endif %}
					<td>
						Action
					</td>
				</tr>
			{% endfor %}
			</tbody>
			</table>
		</div>

		{# buttons #}
		{% if stopArea.id is not null %}
			<div class="row" style="padding: 10px 0 0">
				<div class = "col-md-12">
					<a class="btn btn-default" id="internal-transfert" 
						href="{{ path('tisseo_boa_internal_transfer_edit', {'StopAreaId': stopArea.id }) }}"
						data-toggle="modal" data-target="#base-modal" >
						<span class="glyphicon glyphicon-resize-small"></span>
						{{ 'stop_area.labels.internal_transfert' | trans }}
						</a>
					<a class="btn btn-default" id="external-transfert" 
						href="{{ path('tisseo_boa_external_transfer_edit', {'StopAreaId': stopArea.id }) }}"
						data-toggle="modal" data-target="#base-modal" >
						<span class="glyphicon glyphicon-resize-full"></span>
						{{ 'stop_area.labels.external_transfert' | trans }}
					</a>
					<a class="btn btn-default" id="geometries" href="#">
						<span class="glyphicon glyphicon-globe"></span>
						{{ 'stop_area.labels.geometries' | trans }}
					</a>
					<a class="btn btn-default" id="alias" 
						href="{{ path('tisseo_boa_stop_area_alias', {'StopAreaId': stopArea.id }) }}"
						data-toggle="modal" data-target="#base-modal" >
						<span class="glyphicon glyphicon-tag"></span>
						{{ 'stop_area.labels.alias' | trans }}
					</a>
				</div>
			</div>
		{% endif %}
{% endblock %}

{% block javascripts %}
   <script>
		require(['jquery', 'jquery_ui_autocomplete', 'datatables'], function($) {
			$(document).ready(function() {
				$("#datatable").DataTable({
					"paging":   false,
					"info":     false,
					'searching': false,
					"language": {
						"sZeroRecords":    "{{ 'stop_area.labels.no_stops' | trans }}"
					}
				});
			
				$("#city").autocomplete({
					source: function (request, response) {
						var objData = { term: request.term };
						var url = $(this.element).attr('data-url');
						$.ajax({ url: url, dataType: "json", data : objData,  type: 'POST',
							success: function (data) {
								response($.map(JSON.parse(data.content), function (item) {									
									return {				
										label: item.name, 
										value: item.name, 
										id: item.id
									};
								}));
							},
						});
					},
					select: function (event, ui) {
						$("#boa_stop_area_city").val(ui.item.id);
					},					
					minLength: 3,
					delay: 300
				});
			});
		});
    </script>
{% endblock %}

